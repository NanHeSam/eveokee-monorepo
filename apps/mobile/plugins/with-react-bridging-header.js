const { withDangerousMod } = require("@expo/config-plugins");
const fs = require("fs");
const path = require("path");

const IMPORT_LINES = [
  "#import <React/RCTBridge.h>",
  "#import <React/RCTBundleURLProvider.h>",
  "#import <React/RCTLinkingManager.h>",
];

function ensureImports(contents) {
  const normalized = contents.replace(/\r\n/g, "\n").trimEnd();
  const missing = IMPORT_LINES.filter((line) => !normalized.includes(line));
  if (missing.length === 0) {
    return contents;
  }
  const separator = normalized.endsWith("\n") ? "" : "\n";
  return `${normalized}${separator}\n${missing.join("\n")}\n`;
}

module.exports = function withReactBridgingHeader(config) {
  return withDangerousMod(config, ["ios", (cfg) => {
    const projectRoot = cfg.modRequest.projectRoot;
    const projectName = cfg.modRequest.projectName;
    if (!projectName) {
      return cfg;
    }
    const headerPath = path.join(
      projectRoot,
      "ios",
      projectName,
      `${projectName}-Bridging-Header.h`,
    );

    if (!fs.existsSync(headerPath)) {
      fs.mkdirSync(path.dirname(headerPath), { recursive: true });
      fs.writeFileSync(
        headerPath,
        "//\n// Bridging header generated by with-react-bridging-header config plugin.\n//\n\n",
        "utf8",
      );
    }

    const original = fs.readFileSync(headerPath, "utf8");
    const next = ensureImports(original);
    if (next !== original) {
      fs.writeFileSync(headerPath, next, "utf8");
    }

    return cfg;
  }]);
};

